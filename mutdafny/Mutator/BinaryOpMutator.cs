using Microsoft.Dafny;

namespace MutDafny.Mutator;

public class BinaryOpMutator(int mutationTargetPos, string op, ErrorReporter reporter) : Mutator
{
    public override void Mutate(Statement statement)
    {
        switch (statement) {
            case AssignStatement aStmt: 
                MutateRhsList(aStmt.Rhss); break;
            case ReturnStmt rStmt:
                MutateRhsList(rStmt.Rhss); break;
            case IfStmt ifStmt:
                MutateIfStmtGuard(ifStmt); break;
            case WhileStmt whlStmt:
                MutateWhileStmtGuard(whlStmt); break;
            // TODO: check different types of statements
        }
    }

    private void MutateRhsList(List<AssignmentRhs> rhss)
    {
        foreach (var elem in rhss.Select((value, i) => new {value, i})) {
            var rhs = elem.value;
            if (rhs is not ExprRhs exprRhs) continue;
            var newBinaryExpr = MutateExpression(exprRhs.Expr);
            if (newBinaryExpr == null) continue;
            
            var newAssignmentRhs = new ExprRhs(newBinaryExpr, rhs.Attributes);
            rhss.RemoveAt(elem.i);
            rhss.Insert(elem.i, newAssignmentRhs);
            break;
        }
    }

    private void MutateIfStmtGuard(IfStmt ifStmt)
    {
        if (ifStmt.Guard == null) return;
        var newGuard = MutateExpression(ifStmt.Guard);
        if (newGuard == null) return;
        
        var newIfStmt = new IfStmt(ifStmt.Origin, ifStmt.IsBindingGuard, 
            newGuard, ifStmt.Thn, ifStmt.Els, ifStmt.Attributes
        );
        ReplaceStmtInTargetBlock(ifStmt, newIfStmt);
    }

    private void MutateWhileStmtGuard(WhileStmt whlStmt)
    {
        var newGuard = MutateExpression(whlStmt.Guard);
        if (newGuard == null) return;
        
        var newWhlStmt = new WhileStmt(whlStmt.Origin, newGuard, 
            whlStmt.Invariants, whlStmt.Decreases, whlStmt.Mod,
            whlStmt.Body, whlStmt.Attributes
        );
        ReplaceStmtInTargetBlock(whlStmt, newWhlStmt);
    }

    private BinaryExpr? MutateExpression(Expression expr)
    {
        switch (expr) {
            case BinaryExpr bExpr:
                if (IsTarget(bExpr)) return MutateBinaryExpr(bExpr);
                var lhsMutation = MutateExpression(bExpr.E0);
                if (lhsMutation != null) {
                    return new BinaryExpr(bExpr.Origin, bExpr.Op, lhsMutation, bExpr.E1);
                }
                var rhsMutation = MutateExpression(bExpr.E1);
                if (rhsMutation != null) {
                    return new BinaryExpr(bExpr.Origin, bExpr.Op, bExpr.E0, rhsMutation);
                }
                break;
            case ParensExpression pExpr:
                return MutateExpression(pExpr.E);
            // TODO: check different types of expressions
        }
        return null;
    }
    
    private BinaryExpr MutateBinaryExpr(BinaryExpr expr)
    {
        var newOpcode = (BinaryExpr.Opcode)Enum.Parse(typeof(BinaryExpr.Opcode), op);
        var newBinaryExpr = new BinaryExpr(expr.Origin, newOpcode, expr.E0, expr.E1);

        var binaryExprToken = new AutoGeneratedOrigin(newBinaryExpr.Center);
        reporter.Info(MessageSource.Rewriter, binaryExprToken, $"Operation mutated to {op}");
        return newBinaryExpr;
    }
    
    private bool IsTarget(BinaryExpr expr)
    {
        return expr.Center.pos == mutationTargetPos;
    }
}