using Microsoft.Dafny;

namespace MutDafny.Mutator;

// this mutation operator replaces one binary operator with another
public class BinaryOpMutator(string mutationTargetPos, string op, ErrorReporter reporter) : Mutator(mutationTargetPos, reporter)
{
    private void Mutate(BinaryExpr bExpr) {
        if ((bExpr.Op != BinaryExpr.Opcode.Exp && op == "Exp") || 
            (bExpr.Op == BinaryExpr.Opcode.Exp && op == "Imp")) {
            (bExpr.E0, bExpr.E1) = (bExpr.E1, bExpr.E0);
        }
        bExpr.Op = (BinaryExpr.Opcode)Enum.Parse(typeof(BinaryExpr.Opcode), op);
        
        var binaryExprToken = new AutoGeneratedOrigin(bExpr.Center);
        Reporter.Info(MessageSource.Rewriter, binaryExprToken, $"Operation mutated to {op}");
    }
    
    private bool IsTarget(BinaryExpr expr) {
        return expr.Center.pos == int.Parse(MutationTargetPos);
    }
    
    /// ---------------------------
    /// Group of overriden visitors
    /// ---------------------------
    protected override void VisitExpression(BinaryExpr bExpr) {
        if (IsTarget(bExpr)) {
            TargetExpression = bExpr;
            Mutate(bExpr);
            return;
        }
        base.VisitExpression(bExpr);
    }
    
    protected override void VisitExpression(ChainingExpression cExpr) {
        foreach (var (e, i) in cExpr.Operands.Select((e, i) => (e, i))) {
            if (e.Center.pos != int.Parse(MutationTargetPos)) continue;
            // if the lhs operand is at position i of the operands list
            // then the operator is at position i of the operators list
            cExpr.Operators[i] = (BinaryExpr.Opcode)Enum.Parse(typeof(BinaryExpr.Opcode), op);
            
            var binaryExprToken = new AutoGeneratedOrigin(e.Center);
            Reporter.Info(MessageSource.Rewriter, binaryExprToken, $"Operation mutated to {op}");
            
            if (cExpr.E is BinaryExpr bExpr && bExpr.Op == BinaryExpr.Opcode.And) {
                VisitChainingSubExpression(bExpr.E0);
                if (TargetFound()) return;
                VisitChainingSubExpression(bExpr.E1);
            }
        }
    }

    private void VisitChainingSubExpression(Expression expr) {
        if (expr is BinaryExpr bExpr && bExpr.E0.Center.pos == int.Parse(MutationTargetPos)) {
            TargetExpression = bExpr;
            Mutate(bExpr);
        }
    }
}